<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canadian Postal Code Changes (2022-2026)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #232733;
  --border: #2d3245;
  --text: #e4e6eb;
  --text-dim: #8b8fa3;
  --accent: #6c8cff;
  --green: #4ade80;
  --red: #f87171;
  --yellow: #fbbf24;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; }
.container { max-width: 1200px; margin: 0 auto; padding: 24px; }

/* Header */
header { text-align: center; padding: 40px 0 24px; border-bottom: 1px solid var(--border); margin-bottom: 32px; }
header h1 { font-size: 1.8rem; font-weight: 600; margin-bottom: 8px; }
header p { color: var(--text-dim); font-size: 0.95rem; }

/* Nav tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 32px; background: var(--surface); border-radius: 8px; padding: 4px; }
.tab { flex: 1; padding: 10px 16px; text-align: center; border: none; background: none; color: var(--text-dim); cursor: pointer; border-radius: 6px; font-size: 0.9rem; font-family: var(--font); transition: all 0.15s; }
.tab:hover { color: var(--text); background: var(--surface2); }
.tab.active { background: var(--accent); color: #fff; }

/* Cards */
.cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
.card .label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
.card .value { font-size: 1.8rem; font-weight: 700; font-family: var(--mono); }
.card .value.green { color: var(--green); }
.card .value.red { color: var(--red); }
.card .value.yellow { color: var(--yellow); }
.card .value.accent { color: var(--accent); }

/* Charts */
.chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
.chart-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
.chart-box h3 { font-size: 0.95rem; margin-bottom: 16px; color: var(--text-dim); }
@media (max-width: 768px) { .chart-row { grid-template-columns: 1fr; } }

/* Sections */
.section { margin-bottom: 40px; }
.section h2 { font-size: 1.2rem; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
.section h2 .badge { font-size: 0.75rem; background: var(--surface2); color: var(--text-dim); padding: 2px 10px; border-radius: 12px; font-weight: 400; }
.view { display: none; }
.view.active { display: block; }

/* Search & filters */
.filters { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
.filters input, .filters select {
  padding: 8px 14px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; color: var(--text); font-size: 0.85rem; font-family: var(--font);
  min-width: 160px;
}
.filters input:focus, .filters select:focus { outline: none; border-color: var(--accent); }
.filters input::placeholder { color: var(--text-dim); }

/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
thead th { text-align: left; padding: 10px 12px; background: var(--surface2); color: var(--text-dim); font-weight: 500; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1; }
tbody td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
tbody tr:hover { background: var(--surface2); }
.table-wrap { max-height: 500px; overflow-y: auto; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; }
td.pc { font-family: var(--mono); letter-spacing: 0.05em; }
.change-added { color: var(--green); }
.change-removed { color: var(--red); }
.change-city { color: var(--yellow); }
.sub-badge { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
.sub-technical { background: rgba(139,143,163,0.15); color: var(--text-dim); }
.sub-real { background: rgba(74,222,128,0.15); color: var(--green); }

/* Load more */
.load-more { display: block; width: 100%; padding: 12px; margin-top: 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--accent); cursor: pointer; font-family: var(--font); font-size: 0.9rem; }
.load-more:hover { background: var(--surface2); }

/* Loading */
.loading { text-align: center; padding: 60px 20px; color: var(--text-dim); }
</style>
<script data-goatcounter="https://post-codes.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>Canadian Postal Code Changes</h1>
    <p>Tracking additions, removals, and city name changes across NAR and GeoNames data (2022-2026)</p>
  </header>

  <div class="tabs">
    <button class="tab active" data-view="overview">Overview</button>
    <button class="tab" data-view="removed">Removed</button>
    <button class="tab" data-view="added">Added</button>
    <button class="tab" data-view="city">City Changes</button>
  </div>

  <!-- Overview -->
  <div class="view active" id="view-overview">
    <div class="cards" id="summary-cards"></div>
    <div class="chart-row">
      <div class="chart-box">
        <h3>Changes by Period</h3>
        <canvas id="chart-timeline"></canvas>
      </div>
      <div class="chart-box">
        <h3>Changes by Province</h3>
        <canvas id="chart-provinces"></canvas>
      </div>
    </div>
  </div>

  <!-- Removed -->
  <div class="view" id="view-removed">
    <div class="section">
      <h2>Removed Postal Codes <span class="badge" id="removed-count"></span></h2>
      <div class="filters">
        <input type="text" id="removed-search" placeholder="Search postal code or city...">
        <select id="removed-prov"><option value="">All Provinces</option></select>
      </div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>Postal Code</th><th>Province</th><th>City</th><th>FSA</th><th>Removed</th>
        </tr></thead><tbody id="removed-body"></tbody></table>
      </div>
      <button class="load-more" id="removed-more" style="display:none">Load more...</button>
    </div>
  </div>

  <!-- Added -->
  <div class="view" id="view-added">
    <div class="section">
      <h2>Added Postal Codes <span class="badge" id="added-count"></span></h2>
      <div class="filters">
        <input type="text" id="added-search" placeholder="Search postal code or city...">
        <select id="added-prov"><option value="">All Provinces</option></select>
      </div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>Postal Code</th><th>Province</th><th>City</th><th>FSA</th><th>Added</th>
        </tr></thead><tbody id="added-body"></tbody></table>
      </div>
      <button class="load-more" id="added-more" style="display:none">Load more...</button>
    </div>
  </div>

  <!-- City Changes -->
  <div class="view" id="view-city">
    <div class="section">
      <h2>City Name Changes <span class="badge" id="city-count"></span></h2>
      <div class="filters">
        <input type="text" id="city-search" placeholder="Search postal code or city...">
        <select id="city-prov"><option value="">All Provinces</option></select>
        <select id="city-subtype">
          <option value="">All Subtypes</option>
          <option value="substantive_only">Substantive Only</option>
          <option value="encoding">Encoding/Mojibake</option>
          <option value="accent_normalization">Accent Normalization</option>
          <option value="punctuation">Punctuation</option>
          <option value="spacing">Spacing</option>
          <option value="abbreviation">Abbreviation</option>
          <option value="boundary">Boundary</option>
          <option value="rename">Rename</option>
          <option value="substantive">Substantive</option>
        </select>
      </div>
      <div class="table-wrap">
        <table><thead><tr>
          <th>Postal Code</th><th>Province</th><th>Old City</th><th>New City</th><th>Subtype</th><th>FSA</th><th>Date</th>
        </tr></thead><tbody id="city-body"></tbody></table>
      </div>
      <button class="load-more" id="city-more" style="display:none">Load more...</button>
    </div>
  </div>

  <div class="loading" id="loading">Loading data...</div>

  <footer style="margin-top: 48px; padding: 24px 0; border-top: 1px solid var(--border); text-align: center; color: var(--text-dim); font-size: 0.85rem;">
    <p style="margin-bottom: 8px;">
      <strong>Data Sources:</strong>
      <a href="https://www150.statcan.gc.ca/n1/pub/46-26-0002/462600022022001-eng.htm" target="_blank" style="color: var(--accent);">Statistics Canada NAR</a> (Open Licence) ·
      <a href="https://geocoder.ca" target="_blank" style="color: var(--accent);">Geocoder.ca</a> (CC BY 2.5) ·
      <a href="https://www.geonames.org" target="_blank" style="color: var(--accent);">GeoNames</a> (CC BY 4.0)
    </p>
    <p>
      Software licensed under MIT License · Data subject to original source licenses
    </p>
  </footer>
</div>

<script>
const PAGE_SIZE = 200;
const state = {
  summary: null, timeline: null, byProvince: null,
  added: null, removed: null, cityChanged: null,
  charts: {}
};

// Tab navigation
document.querySelectorAll('.tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('view-' + btn.dataset.view).classList.add('active');
  });
});

// Data loading
async function loadData() {
  try {
    const [summary, timeline, byProvince, added, removed, cityChanged] = await Promise.all([
      fetch('data/summary.json').then(r => r.json()),
      fetch('data/timeline.json').then(r => r.json()),
      fetch('data/by_province.json').then(r => r.json()),
      fetch('data/added.json').then(r => r.json()),
      fetch('data/removed.json').then(r => r.json()),
      fetch('data/city_changed.json').then(r => r.json()),
    ]);
    Object.assign(state, { summary, timeline, byProvince, added, removed, cityChanged });
    document.getElementById('loading').style.display = 'none';
    renderAll();
  } catch (e) {
    document.getElementById('loading').textContent = 'Error loading data. Run: python -m src.cli generate-static';
    console.error(e);
  }
}

function renderAll() {
  renderSummary();
  renderTimeline();
  renderProvinces();
  setupTable('removed', state.removed, renderRemovedRow, ['pc','city','prov','fsa']);
  setupTable('added', state.added, renderAddedRow, ['pc','city','prov','fsa']);
  setupCityTable();
}

// Summary cards
function renderSummary() {
  const s = state.summary;
  document.getElementById('summary-cards').innerHTML = `
    <div class="card"><div class="label">Total Codes</div><div class="value accent">${fmt(s.total_codes)}</div></div>
    <div class="card"><div class="label">Active</div><div class="value green">${fmt(s.active_codes)}</div></div>
    <div class="card"><div class="label">Added</div><div class="value green">${fmt(s.added)}</div></div>
    <div class="card"><div class="label">Removed</div><div class="value red">${fmt(s.removed)}</div></div>
    <div class="card"><div class="label">City Changes</div><div class="value yellow">${fmt(s.city_changed)}</div></div>
    <div class="card"><div class="label">Total Changes</div><div class="value accent">${fmt(s.total_changes)}</div></div>
  `;
}

// Timeline chart
function renderTimeline() {
  const labels = state.timeline.map(t => t.period.replace(' to ', '\n'));
  const ctx = document.getElementById('chart-timeline').getContext('2d');
  state.charts.timeline = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Added', data: state.timeline.map(t => t.added), backgroundColor: '#4ade80' },
        { label: 'Removed', data: state.timeline.map(t => t.removed), backgroundColor: '#f87171' },
        { label: 'City Changed', data: state.timeline.map(t => t.city_changed), backgroundColor: '#fbbf24' },
      ]
    },
    options: {
      responsive: true, plugins: { legend: { labels: { color: '#8b8fa3' } } },
      scales: {
        x: { stacked: true, ticks: { color: '#8b8fa3', font: { size: 10 } }, grid: { color: '#2d3245' } },
        y: { stacked: true, ticks: { color: '#8b8fa3' }, grid: { color: '#2d3245' } },
      }
    }
  });
}

// Province chart
function renderProvinces() {
  const provs = Object.keys(state.byProvince).sort();
  const ctx = document.getElementById('chart-provinces').getContext('2d');
  state.charts.provinces = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: provs,
      datasets: [
        { label: 'Added', data: provs.map(p => state.byProvince[p].added || 0), backgroundColor: '#4ade80' },
        { label: 'Removed', data: provs.map(p => state.byProvince[p].removed || 0), backgroundColor: '#f87171' },
        { label: 'City Changed', data: provs.map(p => state.byProvince[p].city_changed || 0), backgroundColor: '#fbbf24' },
      ]
    },
    options: {
      indexAxis: 'y', responsive: true,
      plugins: { legend: { labels: { color: '#8b8fa3' } } },
      scales: {
        x: { stacked: true, ticks: { color: '#8b8fa3' }, grid: { color: '#2d3245' } },
        y: { stacked: true, ticks: { color: '#8b8fa3', font: { size: 11 } }, grid: { color: '#2d3245' } },
      }
    }
  });
}

// Generic table setup with search + province filter + load more
function setupTable(name, data, rowFn, searchFields) {
  const provinces = [...new Set(data.map(r => r.prov).filter(Boolean))].sort();
  const provSelect = document.getElementById(name + '-prov');
  provinces.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p;
    provSelect.appendChild(opt);
  });

  let shown = 0;
  let filtered = data;

  function applyFilter() {
    const q = document.getElementById(name + '-search').value.toLowerCase();
    const prov = provSelect.value;
    filtered = data.filter(r => {
      if (prov && r.prov !== prov) return false;
      if (q && !searchFields.some(f => (r[f] || '').toLowerCase().includes(q))) return false;
      return true;
    });
    shown = 0;
    document.getElementById(name + '-body').innerHTML = '';
    document.getElementById(name + '-count').textContent = fmt(filtered.length) + ' records';
    loadMore();
  }

  function loadMore() {
    const tbody = document.getElementById(name + '-body');
    const end = Math.min(shown + PAGE_SIZE, filtered.length);
    const frag = document.createDocumentFragment();
    for (let i = shown; i < end; i++) {
      frag.appendChild(rowFn(filtered[i]));
    }
    tbody.appendChild(frag);
    shown = end;
    document.getElementById(name + '-more').style.display = shown < filtered.length ? 'block' : 'none';
  }

  document.getElementById(name + '-search').addEventListener('input', applyFilter);
  provSelect.addEventListener('change', applyFilter);
  document.getElementById(name + '-more').addEventListener('click', loadMore);

  applyFilter();
}

function renderRemovedRow(r) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td class="pc change-removed">${r.pc}</td><td>${r.prov}</td><td>${r.city}</td><td>${r.fsa}</td><td>${r.date}</td>`;
  return tr;
}

function renderAddedRow(r) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td class="pc change-added">${r.pc}</td><td>${r.prov}</td><td>${r.city}</td><td>${r.fsa}</td><td>${r.date}</td>`;
  return tr;
}

function renderCityRow(r) {
  const tr = document.createElement('tr');
  const technical = ['encoding','accent_normalization','punctuation','spacing','abbreviation'];
  const group = technical.includes(r.sub) ? 'technical' : 'real';
  const subBadge = r.sub ? `<span class="sub-badge sub-${group}">${r.sub}</span>` : '';
  tr.innerHTML = `<td class="pc change-city">${r.pc}</td><td>${r.prov}</td><td>${r.old}</td><td>${r.new}</td><td>${subBadge}</td><td>${r.fsa}</td><td>${r.date}</td>`;
  return tr;
}

function setupCityTable() {
  const data = state.cityChanged;
  const name = 'city';

  // Province filter
  const provinces = [...new Set(data.map(r => r.prov).filter(Boolean))].sort();
  const provSelect = document.getElementById('city-prov');
  provinces.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p;
    provSelect.appendChild(opt);
  });

  const subtypeSelect = document.getElementById('city-subtype');

  let shown = 0;
  let filtered = data;

  const technicalSubs = ['encoding','accent_normalization','punctuation','spacing','abbreviation'];

  function applyFilter() {
    const q = document.getElementById('city-search').value.toLowerCase();
    const prov = provSelect.value;
    const sub = subtypeSelect.value;
    filtered = data.filter(r => {
      if (prov && r.prov !== prov) return false;
      if (q && !['pc','old','new','prov','fsa'].some(f => (r[f] || '').toLowerCase().includes(q))) return false;
      if (sub === 'substantive_only') {
        if (technicalSubs.includes(r.sub)) return false;
      } else if (sub && r.sub !== sub) {
        return false;
      }
      return true;
    });
    shown = 0;
    document.getElementById('city-body').innerHTML = '';
    document.getElementById('city-count').textContent = fmt(filtered.length) + ' records';
    loadMore();
  }

  function loadMore() {
    const tbody = document.getElementById('city-body');
    const end = Math.min(shown + PAGE_SIZE, filtered.length);
    const frag = document.createDocumentFragment();
    for (let i = shown; i < end; i++) {
      frag.appendChild(renderCityRow(filtered[i]));
    }
    tbody.appendChild(frag);
    shown = end;
    document.getElementById('city-more').style.display = shown < filtered.length ? 'block' : 'none';
  }

  document.getElementById('city-search').addEventListener('input', applyFilter);
  provSelect.addEventListener('change', applyFilter);
  subtypeSelect.addEventListener('change', applyFilter);
  document.getElementById('city-more').addEventListener('click', loadMore);

  applyFilter();
}

function fmt(n) { return (n || 0).toLocaleString(); }

loadData();
</script>
</body>
</html>
